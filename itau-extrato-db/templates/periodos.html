{% extends "base.html" %}
{% block content %}
<h2>Períodos</h2>
<p class="small">Selecione um intervalo de meses. O gráfico mostra, por dia, Débitos, Créditos e Saldo do dia.</p>

<div class="card">
  <style>
    /* GRID */
    .filter-grid{
      display:grid;
      grid-template-columns:repeat(12,1fr);
      gap:16px;
      align-items:end; /* alinha pela base */
    }
    .col-4{grid-column:span 4}
    .col-12{grid-column:span 12}
    @media (max-width: 768px){
      .col-4,.col-12{grid-column:span 12}
    }

    /* BLOCO PADRÃO (contorno unificado dos filtros) */
    .tool{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:72px;
    }
    .tool .label{margin:0;color:var(--muted);font-size:12px}

    /* Altura padronizada dos inputs e botões */
    .tool .input, .tool select{
      height:40px;
      padding:0 12px;
      line-height:40px;
    }
    .actions .btn{
      display:inline-flex; align-items:center; justify-content:center;
      height:40px; padding:0 14px; line-height:40px;
    }

    /* Chips/blobs com mesmo padrão de borda */
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip.toggle{display:inline-flex;align-items:center;gap:6px;cursor:pointer;
      background:var(--chip); border:1px solid var(--border); border-radius:999px; padding:6px 10px}
    .chip.toggle .blob{
      width:12px;height:12px;border-radius:50%;
      border:2px solid var(--border); background:transparent; transition:all .15s ease;
    }
    .chip.toggle.active{ border-color: var(--accent) }
    .chip.toggle.active .blob{ border-color: var(--accent); box-shadow:0 0 0 2px rgba(90,176,255,.25) }

    /* Linha de botões */
    .actions{display:flex;gap:10px;justify-content:flex-end}
  </style>

  <form method="get" class="filter-grid">
    <!-- Linha 1: filtros lado a lado, todos com o MESMO contorno (tool) -->
    <div class="tool col-4">
      <div class="label">Início (mês)</div>
      <input class="input" type="month" name="start_month" value="{{ start_month }}">
    </div>

    <div class="tool col-4">
      <div class="label">Fim (mês)</div>
      <input class="input" type="month" name="end_month" value="{{ end_month }}">
    </div>

    <div class="tool col-4">
      <div class="label">Séries</div>
      <div class="chips">
        <label class="chip small toggle {{ 'active' if show_debitos else '' }}">
          <input type="checkbox" name="show_debitos" value="1" {{ 'checked' if show_debitos else '' }} hidden>
          <span class="blob"></span> Débitos
        </label>
        <label class="chip small toggle {{ 'active' if show_creditos else '' }}">
          <input type="checkbox" name="show_creditos" value="1" {{ 'checked' if show_creditos else '' }} hidden>
          <span class="blob"></span> Créditos
        </label>
        <label class="chip small toggle {{ 'active' if show_saldo else '' }}">
          <input type="checkbox" name="show_saldo" value="1" {{ 'checked' if show_saldo else '' }} hidden>
          <span class="blob"></span> Saldo do dia
        </label>
      </div>
    </div>

    <!-- Linha 2: botões com MESMA altura/largura visual -->
    <div class="col-12 actions">
      <button class="btn" type="submit">Aplicar</button>
      <a class="btn secondary" href="/periodos" role="button">Limpar</a>
    </div>
  </form>

  <script>
    // mantém estado visual dos chips (contorno e blob)
    document.querySelectorAll('.chip.toggle').forEach(ch=>{
      const cb = ch.querySelector('input[type=checkbox]');
      if (cb) ch.classList.toggle('active', cb.checked);
      ch.addEventListener('click', ()=> setTimeout(()=> ch.classList.toggle('active', cb.checked), 0));
    });
  </script>

  <div class="hr"></div>
  <div class="small">
    Período aplicado:
    <strong>{{ dt_inicio | fmt_date }}</strong> a
    <strong>{{ dt_fim | fmt_date }}</strong>
  </div>
</div>




<!-- === GRÁFICOS === -->

<!-- Débito × Crédito (por dia) -->
<div class="card" style="margin-top:16px">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
    <strong>Débitos × Créditos (por dia)</strong>
    <span class="small">Clique em uma barra para ver as transações do dia</span>
  </div>
  <div class="hr"></div>
  <canvas id="chartDC" height="110"></canvas>
</div>

<!-- Saldo do dia (visualização separada) -->
<div class="card" style="margin-top:16px">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
    <strong>Saldo do dia (por dia)</strong>
    <span class="small">Clique em um ponto para ver as transações do dia</span>
  </div>
  <div class="hr"></div>
  <canvas id="chartSaldo" height="110"></canvas>
</div>

<!-- Painel de detalhes (preenchido via fetch) -->
<div id="detalhe-dia"></div>

<!-- Chart.js (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  // Dados vindos do backend
  const labels   = {{ labels|tojson }};
  const debitos  = {{ debitos|tojson }};
  const creditos = {{ creditos|tojson }};
  const saldoDia = {{ saldo_dia|tojson }};

  // Função comum para abrir detalhe do dia
  async function loadDetalhe(dia){
    const resp = await fetch(`/periodos/detalhe?dia=${encodeURIComponent(dia)}`);
    const html = await resp.text();
    const container = document.getElementById('detalhe-dia');
    container.innerHTML = html;
    container.scrollIntoView({ behavior:'smooth', block:'start' });
  }

  // Gráfico 1: Débitos × Créditos (barras)
  const chartDC = new Chart(document.getElementById('chartDC'), {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Débitos',  type:'bar', data: debitos },
        { label: 'Créditos', type:'bar', data: creditos }
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: 'nearest', intersect: true },
      scales: { x:{ stacked:false }, y:{ beginAtZero:true } },
      plugins: { legend:{ position:'top' } },
      onClick: (evt, elements) => {
        if (!elements?.length) return;
        const idx = elements[0].index;
        loadDetalhe(labels[idx]);
      }
    }
  });

  // Gráfico 2: Saldo do dia (linha)
  const chartSaldo = new Chart(document.getElementById('chartSaldo'), {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'Saldo do dia', type:'line', data: saldoDia, tension: 0.25, pointRadius: 3 }
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: 'nearest', intersect: true },
      scales: { x:{}, y:{ beginAtZero:false } },
      plugins: { legend:{ position:'top' } },
      onClick: (evt, elements) => {
        if (!elements?.length) return;
        const idx = elements[0].index;
        loadDetalhe(labels[idx]);
      }
    }
  });
</script>

{% endblock %}
