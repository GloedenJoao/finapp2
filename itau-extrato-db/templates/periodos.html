{% extends "base.html" %}
{% block content %}
<h2>Períodos</h2>
<p class="small">Selecione um intervalo de meses. O gráfico mostra, por dia, Débitos, Créditos e Saldo do dia.</p>

<div class="card">
  <style>
    .filter-grid{ display:grid; grid-template-columns:repeat(12,1fr); gap:16px; align-items:end }
    .col-4{ grid-column:span 4 } .col-12{ grid-column:span 12 }
    @media (max-width: 768px){ .col-4,.col-12{ grid-column:span 12 } }
    .tool{ background:var(--panel); border:1px solid var(--border); border-radius:12px;
           padding:12px; display:flex; flex-direction:column; gap:8px; min-height:72px }
    .tool .label{ margin:0; color:var(--muted); font-size:12px }
    .tool .input{ height:40px; padding:0 12px; line-height:40px }
    .chips{ display:flex; gap:8px; flex-wrap:wrap }
    .chip.toggle{ display:inline-flex; align-items:center; gap:6px; cursor:pointer;
                  background:var(--chip); border:1px solid var(--border); border-radius:999px; padding:6px 10px }
    .chip.toggle .blob{ width:12px;height:12px;border-radius:50%; border:2px solid var(--border); transition:all .15s }
    .chip.toggle.active{ border-color:var(--accent) }
    .chip.toggle.active .blob{ border-color:var(--accent); box-shadow:0 0 0 2px rgba(90,176,255,.25) }
    .actions{ display:flex; gap:10px; justify-content:flex-end }
    .actions .btn{ display:inline-flex; align-items:center; justify-content:center; height:40px; padding:0 14px; line-height:40px }
  </style>

  <form method="get" class="filter-grid">
    <!-- Linha 1 -->
    <div class="tool col-4">
      <div class="label">Início (data)</div>
      <input class="input" type="date" name="start" value="{{ start }}">
    </div>

    <div class="tool col-4">
      <div class="label">Fim (data)</div>
      <input class="input" type="date" name="end" value="{{ end }}">
    </div>

    <div class="tool col-4">
      <div class="label">Séries</div>

      <!-- envia 0 quando desmarcado -->
      <input type="hidden" name="show_debitos"  value="0">
      <input type="hidden" name="show_creditos" value="0">
      <input type="hidden" name="show_saldo"    value="0">

      <div class="chips">
        <label class="chip small toggle {{ 'active' if show_debitos else '' }}">
          <input type="checkbox" name="show_debitos" value="1" {{ 'checked' if show_debitos else '' }} hidden>
          <span class="blob"></span> Débitos
        </label>
        <label class="chip small toggle {{ 'active' if show_creditos else '' }}">
          <input type="checkbox" name="show_creditos" value="1" {{ 'checked' if show_creditos else '' }} hidden>
          <span class="blob"></span> Créditos
        </label>
        <label class="chip small toggle {{ 'active' if show_saldo else '' }}">
          <input type="checkbox" name="show_saldo" value="1" {{ 'checked' if show_saldo else '' }} hidden>
          <span class="blob"></span> Saldo do dia
        </label>
      </div>
    </div>

    <!-- Linha 2 -->
    <div class="col-12 actions">
      <button class="btn" type="submit">Aplicar</button>
      <a class="btn secondary" href="/periodos" role="button">Limpar</a>
    </div>
  </form>

  <script>
    // estado visual dos chips
    document.querySelectorAll('.chip.toggle').forEach(ch=>{
      const cb = ch.querySelector('input[type=checkbox]');
      if (cb) ch.classList.toggle('active', cb.checked);
      ch.addEventListener('click', ()=> setTimeout(()=> ch.classList.toggle('active', cb.checked), 0));
    });
  </script>

  <div class="hr"></div>
  <div class="small">
    Período aplicado:
    <strong>{{ dt_inicio | fmt_date }}</strong> a
    <strong>{{ dt_fim | fmt_date }}</strong>
  </div>
</div>



<!-- === GRÁFICOS === -->

<!-- === GRÁFICOS === -->

<!-- Débito × Crédito (por dia) -->
<div class="card" id="card-dc" {% if not show_debitos and not show_creditos %}style="display:none"{% endif %} >
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
    <strong>Débitos - Créditos (por dia)</strong>
    <span class="small">Clique em uma barra para ver as transações do dia</span>
  </div>
  <div class="hr"></div>
  <canvas id="chartDC" height="110"></canvas>
</div>

<!-- Saldo do dia (separado) -->
<div class="card" id="card-saldo" {% if not show_saldo %}style="display:none"{% endif %} >
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
    <strong>Saldo do dia (por dia)</strong>
    <span class="small">Clique em um ponto/coluna para ver as transações do dia</span>
  </div>
  <div class="hr"></div>
  <canvas id="chartSaldo" height="110"></canvas>
</div>

<!-- Painel de detalhes (preenchido via fetch) -->
<div id="detalhe-dia"></div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  // Dados do backend (NOMES ALINHADOS ao Python!)
  const labels    = {{ labels|tojson }};       // ['YYYY-MM-DD', ...]
  const debitos   = {{ debitos|tojson }};      // [n, n, ...]
  const creditos  = {{ creditos|tojson }};     // [n, n, ...]
  const saldoDia  = {{ saldo_dia|tojson }};    // [n|null, ...]

  // Flags vindas do backend
  const showDebitos  = {{ 1 if show_debitos else 0 }};
  const showCreditos = {{ 1 if show_creditos else 0 }};
  const showSaldo    = {{ 1 if show_saldo else 0 }};

  async function loadDetalhe(dia){
    const resp = await fetch(`/periodos/detalhe?dia=${encodeURIComponent(dia)}`);
    const html = await resp.text();
    const container = document.getElementById('detalhe-dia');
    container.innerHTML = html;
    container.scrollIntoView({ behavior:'smooth', block:'start' });
  }

  // Helper genérico para clique em qualquer chart (bar/line)
  function hookClickOpenDetails(chartInstance, canvasEl){
    canvasEl.addEventListener('click', (evt)=>{
      const points = chartInstance.getElementsAtEventForMode(evt, 'nearest', {intersect:true}, true);
      if (!points || !points.length) return;
      const idx = points[0].index;
      loadDetalhe(labels[idx]);
    });
  }

  // === Gráfico Débito × Crédito (barras) ===
  (function(){
    if (!showDebitos && !showCreditos) return; // evita chart vazio

    const ds = [];
    if (showDebitos)  ds.push({ label:'Débitos',  type:'bar', data: debitos });
    if (showCreditos) ds.push({ label:'Créditos', type:'bar', data: creditos });

    const ctx = document.getElementById('chartDC');
    const chart = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: ds },
      options: {
        responsive: true,
        interaction: { mode: 'nearest', intersect: true },
        scales: { x:{ stacked:false }, y:{ beginAtZero:true } },
        plugins: { legend:{ position:'top' } }
      }
    });

    hookClickOpenDetails(chart, ctx);
  })();

  // === Gráfico Saldo do dia (linha) ===
  (function(){
    if (!showSaldo) return;

    const ctx = document.getElementById('chartSaldo');
    const chart = new Chart(ctx, {
      type: 'line',   // se quiser colunas: troque para 'bar'
      data: {
        labels,
        datasets: [
          { label:'Saldo do dia', data: saldoDia, tension:0.25, pointRadius:3 }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: 'nearest', intersect: true },
        scales: { x:{}, y:{ beginAtZero:false } },
        plugins: { legend:{ position:'top' } }
      }
    });

    hookClickOpenDetails(chart, ctx);
  })();
</script>


{% endblock %}
